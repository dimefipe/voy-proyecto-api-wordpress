<!-- final2.html -->
<style>
  /* ====== CONTENEDOR APP ====== */
  #portafolioApp {
      font-family: Unbounded, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1140px;
      margin: auto;
      height: auto;
      min-height: 0;
  }
  #portafolioApp a { text-decoration: none; }
  #portafolioApp button, #portafolioApp input {
      font-family: Unbounded, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  #portafolioApp input { padding: 0.75rem 1rem; }
  #portafolioApp input:focus { outline: none; }
  #portafolioApp button {
      transition: 0.2s ease-in-out; cursor: pointer; padding: 0.5rem 1rem; outline: none; border: none;
  }

  /* ====== FILTROS ====== */
  #portafolioApp .portafolio__filtros{
      display:flex; flex-direction:column; gap:1rem; justify-content:center; align-items:center; margin-bottom:2rem;
  }
  #portafolioApp .portafolio__buscador--box{ width:100%; display:flex; justify-content:center; }
  #portafolioApp .portafolio__buscador{
      background:#e9f6f8!important; border:3px solid #88bac1!important; border-radius:24px!important;
      text-align:center; max-width:600px!important; width:100%!important;
  }
  #portafolioApp .portafolio__buscador:focus{ border:3px solid #ffb000!important; }
  @media (max-width:1024px){
      #portafolioApp .portafolio__buscador--box{ padding-top:.5rem; margin-bottom:.5rem; }
      #portafolioApp .portafolio__buscador{ border:2px solid #88bac1!important; }
      #portafolioApp .portafolio__buscador:focus{ border:2px solid #ffb000!important; }
  }
  @media (max-width:767px){
      #portafolioApp .portafolio__buscador{
          font-size:12px!important; padding:6px!important; min-height:inherit!important; height:inherit!important; border:2px solid #88bac1!important;
      }
      #portafolioApp .portafolio__buscador:focus{ border:2px solid #ffb000!important; }
  }

  #portafolioApp .portafolio__filtros--box{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
  #portafolioApp .portafolio__filtros button{ background:#00272d; color:#fff; border:1px solid #00424d; border-radius:8px; }
  #portafolioApp .portafolio__filtros button:hover{ background:#00b5cf; }
  #portafolioApp .portafolio__filtros button.active{ background:#ffb000; color:#001519; }

  /* ====== GRID ====== */
  #portafolioApp .portafolio__proyectos{
      display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:1rem; --m-top:70px; padding-top:0px!important;
  }
  #portafolioApp .portafolio__proyectos-wrapper{ display:flow-root; margin-bottom:1rem; }

  /* ====== CARD ====== */
  #portafolioApp .portafolio__proyecto{
      background:#00272d; border:1px solid #00424d; border-radius:16px; padding:20px; position:relative;
      display:flex; flex-direction:column; justify-content:space-between; gap:8px;
      margin-top:var(--m-top); margin-bottom:calc(var(--m-top) / 5); isolation:isolate;
  }
  #portafolioApp .portafolio__proyecto a{ display:flex; flex-direction:column; gap:8px; }

  /* Imagen con skeleton propio */
  #portafolioApp .portafolio__img{ aspect-ratio:1/1; position:relative; margin-top:calc(-1 * var(--m-top)); }
  #portafolioApp .portafolio__img img{
      display:block; width:100%; aspect-ratio:1/1; object-fit:cover;
      mask-image:linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 60%, rgba(0,0,0,0) 100%);
      opacity:0; transition:opacity .3s ease-in-out, transform .3s ease-in-out;
  }
  #portafolioApp .portafolio__img img.is-loaded{ opacity:1; }
  #portafolioApp .img-skeleton{ position:absolute; inset:0; pointer-events:none; z-index:1; }
  #portafolioApp .img-skeleton .skeleton-box{ height:100%; width:100%; border-radius:12px; }

  #portafolioApp .portafolio__titulo h3{ color:#fff; font-size:16px; margin:0; transition:.3s; }
  #portafolioApp .portafolio__proyecto a:hover h3{ color:#ffb000; }
  #portafolioApp .portafolio__proyecto a:hover .portafolio__img img{ transform:scale(1.19) translateY(-20px); }

  #portafolioApp .portafolio__categorias{ display:flex; flex-wrap:wrap; gap:10px; }
  #portafolioApp .portafolio__categoria{
      background:#00272d; border:1px solid #00424d; width:max-content; color:#b7bbbc;
      padding:4px 8px; border-radius:8px; font-size:10px; cursor:pointer !important;
      user-select:none; -webkit-user-select:none; display:inline-flex; align-items:center; line-height:1;
  }
  #portafolioApp .portafolio__categoria:hover{ background:#ffb000; color:#001519; }
  #portafolioApp .portafolio__categoria *{ cursor:inherit; }

  /* ====== SKELETON (listado inicial) ====== */
  #portafolioApp .skeleton .portafolio__categoria{ pointer-events:none; }
  #portafolioApp .skeleton-box{ position:relative; overflow:hidden; background:#09343b; border-radius:8px; }
  #portafolioApp .skeleton-box::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.06) 50%, rgba(255,255,255,0) 100%);
      animation:sk-shimmer 1.2s linear infinite; will-change:transform;
  }
  #portafolioApp .skeleton-img{ width:100%; aspect-ratio:1/1; border-radius:12px; }
  #portafolioApp .skeleton-line{ height:14px; margin-top:10px; border-radius:6px; }
  #portafolioApp .skeleton-title{ width:70%; }
  #portafolioApp .skeleton-pill{ display:inline-block; height:18px; width:92px; border-radius:8px; border:1px solid #00424d; }
  #portafolioApp .skeleton-pill.short{ width:64px; }

  /* ====== TRANSITION-GROUP (entradas/salidas/reordenamientos) ====== */
  #portafolioApp .card-enter-from{ opacity:0; transform:translateY(8px); }
  #portafolioApp .card-enter-active{ transition:opacity .35s ease, transform .35s ease; }
  #portafolioApp .card-enter-to{ opacity:1; transform:none; }

  #portafolioApp .card-leave-from{ opacity:1; transform:none; }
  #portafolioApp .card-leave-active{ transition:opacity .25s ease, transform .25s ease; pointer-events:none; }
  #portafolioApp .card-leave-to{ opacity:0; transform:translateY(-4px); }

  #portafolioApp .card-move{ transition:transform .35s ease; will-change:transform; }

  /* ðŸ‘‰ primer pintado tras skeleton */
  #portafolioApp .card-appear-from{ opacity:0; transform:translateY(8px); }
  #portafolioApp .card-appear-active{ transition:opacity .35s ease, transform .35s ease; }
  #portafolioApp .card-appear-to{ opacity:1; transform:none; }

  @media (prefers-reduced-motion: reduce){
      #portafolioApp .card-enter-active,
      #portafolioApp .card-leave-active,
      #portafolioApp .card-appear-active,
      #portafolioApp .card-move{ transition:none !important; }
  }

  /* ====== PAGINADOR / EMPTY ====== */
  #portafolioApp .portafolio__paginador{ display:flex; justify-content:center; gap:1rem; }
  #portafolioApp .portafolio__paginador button{
      font-size:12px; padding:8px 16px; border-radius:8px; background:#00272d; border:1px solid #00424d;
      color:hsla(200,50%,100%,.7);
  }
  #portafolioApp .portafolio__paginador button.current{ background:#00b5cf!important; color:#fff!important; }
  #portafolioApp .no-results{
      color:#fff; text-align:center; padding:2rem; opacity:.5; display:flex; justify-content:center; align-items:center;
      padding-bottom:100px; grid-column:1/-1;
  }
  #portafolioApp .no-results p{ margin:0; }

  /* ====== TABLET / MÃ“VIL ====== */
  @media (max-width:1024px){
      #portafolioApp .portafolio__filtros button{ font-size:14px; }
      #portafolioApp .portafolio__proyectos{ grid-template-columns:repeat(3, minmax(0, 1fr)); --m-top:60px; }
      #portafolioApp .skeleton-title{ width:80%; }
      #portafolioApp .skeleton-pill{ height:18px; }
  }
  @media (max-width:767px){
      #portafolioApp .portafolio__filtros{
          position:sticky; gap:.5rem; top:0; z-index:3; background:#001519;
          mask-image:linear-gradient(to bottom, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 90%, rgba(0,0,0,0) 100%);
          padding-top:.5rem; padding-bottom:1rem;
      }
      #portafolioApp .portafolio__filtros button{ font-size:10px; padding:6px 10px; line-height:1em; min-height:inherit; }
      #portafolioApp .portafolio__proyectos{ grid-template-columns:repeat(2, minmax(0, 1fr)); gap:1rem; --m-top:50px; }
      #portafolioApp .portafolio__proyecto{ padding:12px; }
      #portafolioApp .portafolio__titulo h3{ font-size:12px; }
      #portafolioApp .portafolio__categoria{ padding:2px 6px; font-size:8px; text-decoration:none; }
      #portafolioApp .portafolio__paginador{ gap:.5rem; }
      #portafolioApp .portafolio__paginador button{ font-size:10px; padding:4px 12px; border-radius:8px; }
      #portafolioApp .skeleton-title{ width:85%; }
      #portafolioApp .skeleton-pill{ height:16px; }
  }

  /* ====== SHIMMER KEYFRAMES (incluye fallback Safari) ====== */
  @-webkit-keyframes sk-shimmer { 100% { -webkit-transform: translateX(100%); transform: translateX(100%); } }
  @keyframes sk-shimmer { 100% { transform: translateX(100%); } }
</style>


<div id="portafolioApp">
    
    <div id="portafolioApp">
  <!--<div class="portafolio__listado">-->
  <!--  <div class="portafolio__proyectos-wrapper">-->
  <!--    <div class="portafolio__proyectos">-->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->
        
        <!-- Card de ejemplo -->
  <!--      <div class="portafolio__proyecto">-->
  <!--        <a href="#" target="_blank" rel="noopener">-->
  <!--          <div class="portafolio__img">-->
              <!-- Pon/quita la clase is-loaded para ver la transiciÃ³n -->
  <!--            <img-->
  <!--              src="https://picsum.photos/seed/portafolio-demo/800/800"-->
  <!--              alt="Proyecto de prueba"-->
  <!--              class="is-loaded"-->
  <!--              loading="lazy"-->
  <!--              decoding="async"-->
  <!--            />-->
              <!-- Skeleton: dÃ©jalo con hidden; para verlo quita 'hidden' y quita 'is-loaded' del <img> -->
  <!--            <div class="img-skeleton" hidden>-->
  <!--              <div class="skeleton-box"></div>-->
  <!--            </div>-->
  <!--          </div>-->

  <!--          <div class="portafolio__titulo">-->
  <!--            <h3>Proyecto de Prueba</h3>-->
  <!--          </div>-->
  <!--        </a>-->
  <!--        <div class="portafolio__categorias">-->
  <!--          <span class="portafolio__categoria">Branding</span>-->
  <!--          <span class="portafolio__categoria">Video y Motion</span>-->
  <!--          <span class="portafolio__categoria">Web</span>-->
  <!--        </div>-->
  <!--      </div>-->
        <!-- /Card de ejemplo -->

        <!-- Duplica el bloque .portafolio__proyecto para maquetar mÃ¡s columnas/filas -->
        
  <!--    </div>-->
  <!--  </div>-->
  <!--</div>-->
</div>
    
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp, ref, onMounted } = Vue;

createApp({
  template: `
    <div>
      <div class="portafolio__filtros">
        <div class="portafolio__buscador--box">
          <input class="portafolio__buscador" type="text"
                 v-model="searchTerm" placeholder="Buscar proyectos..."
                 @input="debouncedSearch">
        </div>
        <div class="portafolio__filtros--box">
          <button :class="{ active: activeCategory === null }" @click="changeCategory(null)">Todo</button>
          <button v-for="cat in categories" :key="cat.id"
                  :class="{ active: activeCategory === cat.id }"
                  @click="changeCategory(cat.id)">{{ cat.name }}</button>
        </div>
      </div>

      <div class="portafolio__listado">
        <div class="portafolio__proyectos-wrapper">

          <!-- SKELETON del grid en primera carga -->
          <div class="portafolio__proyectos" v-if="loading">
            <div class="portafolio__proyecto skeleton" v-for="n in skeletonItems" :key="'sk-'+n">
              <a href="javascript:void(0)">
                <div class="portafolio__img"><div class="skeleton-box skeleton-img"></div></div>
                <div class="portafolio__titulo"><div class="skeleton-box skeleton-line skeleton-title"></div></div>
              </a>
              <div class="portafolio__categorias">
                <span class="portafolio__categoria skeleton-box skeleton-pill"></span>
                <span class="portafolio__categoria skeleton-box skeleton-pill"></span>
                <span class="portafolio__categoria skeleton-box skeleton-pill short"></span>
              </div>
            </div>
          </div>

          <!-- LISTA con transiciÃ³n de apariciÃ³n por card -->
          <div v-else>
            <transition-group
              name="card"
              tag="div"
              class="portafolio__proyectos"
              appear
            >
              <div v-for="(item,i) in projects" :key="item.id" class="portafolio__proyecto">
                <a :href="item.link" target="_blank" rel="noopener">
                  <div class="portafolio__img">
                    <img :src="item.image"
                         :srcset="item.srcset && item.srcset.length ? item.srcset : undefined"
                         sizes="(max-width:767px) 50vw, (max-width:1024px) 33vw, 25vw"
                         :alt="item.title.rendered"
                         :class="{'is-loaded': item._imgLoaded}"
                         :fetchpriority="i < 4 ? 'high' : 'auto'"
                         @load="onImgLoad(item, $event)"
                         @error="onImgError(item, $event)"
                         loading="lazy" decoding="async" />
                    <!-- Skeleton SOLO de la imagen hasta que cargue -->
                    <div v-if="!item._imgLoaded" class="img-skeleton">
                      <div class="skeleton-box"></div>
                    </div>
                  </div>
                  <div class="portafolio__titulo"><h3>{{ item.title.rendered }}</h3></div>
                </a>
                <div class="portafolio__categorias">
                  <span v-for="cat in item.project_cat_links" :key="cat.id"
                        class="portafolio__categoria" @click="changeCategory(cat.id)">
                    {{ cat.name }}
                  </span>
                </div>
              </div>
            </transition-group>

            <div v-if="!projects.length" class="no-results"><p>Sin resultados</p></div>
          </div>

        </div>

        <div v-show="totalPages > 1" class="portafolio__paginador">
          <button @click="changePage(currentPage - 1)" :disabled="currentPage === 1">Anterior</button>
          <button v-for="page in totalPages" :key="page"
                  @click="changePage(page)" :class="{ current: currentPage === page }">{{ page }}</button>
          <button @click="changePage(currentPage + 1)" :disabled="currentPage === totalPages">Siguiente</button>
        </div>
      </div>
    </div>
  `,
  setup() {
    // ðŸ‘‰ NUEVO endpoint combinado
    const API_BASE = 'https://voy.digital/wp-json/voy/v1';
    const PLACEHOLDER = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';

    const projects       = ref([]);
    const categories     = ref([]);
    const activeCategory = ref(null); // guarda el ID de la categorÃ­a seleccionada
    const currentPage    = ref(1);
    const totalPages     = ref(1);
    const loading        = ref(false);
    const itemsPerPage   = 8;
    const searchTerm     = ref('');
    const skeletonItems  = Array.from({ length: itemsPerPage }, (_, i) => i + 1);
    let   searchTimeout  = null;

    // cache simple en memoria
    const cache = new Map();
    const keyFor = (p) =>
      `${activeCategory.value != null ? activeCategory.value : 'all'}|${(searchTerm.value || '').trim()}|${p}`;
    let ctrl = null;

    // Llama al endpoint combinado: /voy/v1/portfolio
    const fetchAll = async (page = 1) => {
      const k = keyFor(page);
      if (cache.has(k)) {
        const { items, cats, total } = cache.get(k);
        projects.value   = items;
        totalPages.value = total;
        if (!categories.value.length && cats?.length) categories.value = cats;
        return;
      }

      if (ctrl) ctrl.abort();
      ctrl = new AbortController();

      loading.value = true;
      try {
        const url = new URL(`${API_BASE}/portfolio`);
        url.searchParams.set('per_page', itemsPerPage);
        url.searchParams.set('page', page);

        const q = (searchTerm.value || '').trim();
        if (q) url.searchParams.set('search', q);
        if (activeCategory.value) url.searchParams.set('category', activeCategory.value); // id o slug

        const res  = await fetch(url.toString(), { signal: ctrl.signal, cache: 'no-store' });
        const data = await res.json();

        const items = (data.projects || []).map(post => {
          const noMedia = !post.image;
          return {
            ...post,
            image: noMedia ? PLACEHOLDER : post.image,
            srcset: post.srcset || '',
            _imgLoaded: noMedia ? true : false,
          };
        });

        projects.value   = items;
        totalPages.value = data.total_pages || 1;
        if (!categories.value.length && Array.isArray(data.categories)) {
          categories.value = data.categories;
        }

        cache.set(k, { items, cats: categories.value, total: totalPages.value });
      } catch (e) {
        if (e.name !== 'AbortError') {
          console.error('Error fetchAll:', e);
          projects.value = [];
          totalPages.value = 1;
        }
      } finally {
        loading.value = false;
      }
    };

    // Img handlers
    const onImgLoad = (item) => { item._imgLoaded = true; };
    const onImgError = (item, ev) => {
      const img = ev?.target;
      if (img) { img.src = PLACEHOLDER; img.removeAttribute('srcset'); }
      item._imgLoaded = true;
    };

    // UI actions
    const changeCategory = (categoryId) => {
      activeCategory.value = categoryId;
      if (searchTerm.value) searchTerm.value = '';
      currentPage.value = 1;
      updateURL();
      fetchAll(currentPage.value);
    };

    const changePage = (page) => {
      if (page >= 1 && page <= totalPages.value){
        currentPage.value = page;
        updateURL();
        fetchAll(page);
        const el = document.getElementById('portafolioApp');
        if (el) el.scrollIntoView({ behavior: 'smooth' });
      }
    };

    const updateURL = () => {
      const sel  = categories.value.find(c => c.id === activeCategory.value);
      const slug = sel ? sel.slug : null;
      const p = new URLSearchParams();
      if (currentPage.value > 1) p.set('page', currentPage.value);
      if (slug) p.set('cat', slug);
      const q = (searchTerm.value || '').trim(); if (q) p.set('search', q);
      history.replaceState(null, '', `?${p.toString()}`);
    };

    // Lee ?page, ?cat (slug) y ?search del URL
    const loadFromURL = () => {
      const p = new URLSearchParams(window.location.search);
      if (p.get('page')) currentPage.value = parseInt(p.get('page'), 10) || 1;
      const slug = p.get('cat');
      if (p.get('search')) searchTerm.value = p.get('search');

      // Cuando ya tengamos categories desde la primera llamada, resolvemos el slug a ID
      const tryResolveSlug = () => {
        if (!slug || !categories.value.length) return;
        const m = categories.value.find(c => c.slug === slug);
        if (m) activeCategory.value = m.id;
      };
      return tryResolveSlug;
    };

    const debouncedSearch = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentPage.value = 1;
        updateURL();
        fetchAll(1);
      }, 650);
    };

    onMounted(async () => {
      const resolveSlug = loadFromURL();
      await fetchAll(currentPage.value); // 1Âª carga (trae tambiÃ©n categorÃ­as)
      resolveSlug && resolveSlug();      // si venÃ­a ?cat=slug, conviÃ©rtelo a ID
      if (activeCategory.value) await fetchAll(currentPage.value); // recarga con la cat aplicada
    });

    return {
      // state
      loading, categories, activeCategory, currentPage, totalPages,
      projects, searchTerm, skeletonItems,
      // actions
      changeCategory, changePage, debouncedSearch,
      // img handlers
      onImgLoad, onImgError
    };
  }
}).mount('#portafolioApp');
</script>

